<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaylosCAM Agora Tarayıcı Testi</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #videos { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .player { width: 100%; max-width: 400px; height: 300px; background: black; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; }
        .controls button { padding: 10px; margin: 5px; border-radius: 5px; }
        #disconnectButton { background-color: #dc3545; color: white; border: none; }
    </style>
</head>
<body>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    
    <h1>TaylosCAM Tarayıcı Testi</h1>
    
    <div class="controls">
        <input type="text" id="roomInput" placeholder="Oda Adı" value="test_oda1">
        <button onclick="connectRoom()" id="joinButton">Odaya Katıl</button>
        <button onclick="disconnect()" disabled id="disconnectButton">Odadan Ayrıl</button>
    </div>
    
    <div id="videos">
        <div id="local-player" class="player"><h3>Siz (Local)</h3></div>
    </div>

<script>
// =======================================================
// Sizin Agora Bilgileriniz
// =======================================================
const APP_ID = "c5635d92de804ae4a0142334625dba50"; 
const TOKEN = "e9327df8a1e146bc87e9448c5caa89c1"; // Eğer yeni token almadıysanız eski token
const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let localTracks = [];
const uid = Math.floor(Math.random() * 10000).toString(); // Rastgele Kullanıcı ID'si

// =======================================================
// Olay Dinleyicileri (Karşı taraf bağlandığında/ayrıldığında)
// =======================================================
client.on("user-published", async (user, mediaType) => {
    await client.subscribe(user, mediaType);
    if (mediaType === "video") {
        const remoteVideoTrack = user.videoTrack;
        const remotePlayerContainer = document.createElement("div");
        remotePlayerContainer.id = `remote-player-${user.uid}`;
        remotePlayerContainer.className = "player";
        remotePlayerContainer.innerHTML = `<h3>Kullanıcı ${user.uid}</h3>`;
        document.getElementById("videos").appendChild(remotePlayerContainer);
        remoteVideoTrack.play(remotePlayerContainer.id);
    }
    if (mediaType === "audio") {
        user.audioTrack.play();
    }
});

client.on("user-unpublished", (user) => {
    const remotePlayerContainer = document.getElementById(`remote-player-${user.uid}`);
    if (remotePlayerContainer) remotePlayerContainer.remove();
});

// =======================================================
// Bağlantı Fonksiyonları
// =======================================================
async function connectRoom() {
    const roomID = document.getElementById('roomInput').value.trim();
    if (!roomID) return alert("Lütfen Oda Adı girin.");

    try {
        // 1. Odaya Katılma
        await client.join(APP_ID, roomID, TOKEN, uid); 
        
        // 2. Yerel Akışı Oluşturma (Kamera ve Mikrofon izni istenir)
        localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
        
        // 3. Kendi Akışını Oynatma
        localTracks[1].play("local-player"); 
        
        // 4. Akışı Yayınlama
        await client.publish(localTracks);
        
        // Başarılı olursa butonları güncelle
        document.getElementById('joinButton').disabled = true;
        document.getElementById('disconnectButton').disabled = false;
        document.getElementById('local-player').innerHTML = '<h3>Siz (Local) - Yayında</h3>';
        
    } catch (error) {
        console.error("Bağlantı veya medya hatası:", error);
        alert("Bağlantı Başarısız. Console'daki hatayı kontrol edin. Muhtemel sebep: Token Süresi Doldu.");
        await disconnect();
    }
}

async function disconnect() {
    for (track of localTracks) {
        if (track) { track.stop(); track.close(); }
    }
    localTracks = [];
    try { await client.leave(); } catch(e) {}
    
    document.getElementById("videos").innerHTML = `<div id="local-player" class="player"><h3>Siz (Local)</h3></div>`;
    document.getElementById('joinButton').disabled = false;
    document.getElementById('disconnectButton').disabled = true;
}
window.connectRoom = connectRoom;
window.disconnect = disconnect;
</script>
</body>
</html>
